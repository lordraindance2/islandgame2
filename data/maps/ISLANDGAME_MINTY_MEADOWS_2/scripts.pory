//VAR_MINTY_MEADOWS_STATE:
//0 - nothing
//1 - initiate quest
//2 - saw mareep once
//3 - final saw mareep
//4 - defeated battle with mightyena

const STATE_INITIAL_RIVAL = 0
const STATE_STARTED_QUEST = 1
const STATE_FIRST_MAREEP_SIGHTING = 2
const STATE_PRE_FIGHT_SIGHTING = 3
const STATE_POST_FIGHT = 4

const RIVAL_OW_ID = 16
const OLD_MAN_OW_ID = 17
const MAREEP_OW_ID = 11
const MIGHTYENA_OW_ID = 12

const POS_HIDDEN_X = -3
const POS_HIDDEN_Y = 1

mapscripts ISLANDGAME_MINTY_MEADOWS_2_MapScripts {
    MAP_SCRIPT_ON_TRANSITION: ISLANDGAME_MINTY_MEADOWS_2_OnTransition
}

script ISLANDGAME_MINTY_MEADOWS_2_OnTransition {
    switch (var(VAR_MINTY_MEADOWS_STATE)) {
        case STATE_INITIAL_RIVAL:            call(ISLANDGAME_MINTY_MEADOWS_2_InitialRival)
        case STATE_STARTED_QUEST:            call(ISLANDGAME_MINTY_MEADOWS_2_StartedQuest)
        case STATE_FIRST_MAREEP_SIGHTING:    call(ISLANDGAME_MINTY_MEADOWS_2_SawMareepFirst)
        case STATE_PRE_FIGHT_SIGHTING:       call(ISLANDGAME_MINTY_MEADOWS_2_SawMareepPreFight)
        case STATE_POST_FIGHT:               call(ISLANDGAME_MINTY_MEADOWS_2_DefeatedMightyena)
    }
}

// Sets up the Rival fight and old man blocking the side
script ISLANDGAME_MINTY_MEADOWS_2_InitialRival {
    setobjectxyperm(RIVAL_OW_ID, 12, 0)
    setobjectxyperm(OLD_MAN_OW_ID, 31, 10)
    setobjectxyperm(MAREEP_OW_ID, POS_HIDDEN_X, POS_HIDDEN_Y)
    setobjectxyperm(MIGHTYENA_OW_ID, POS_HIDDEN_X, POS_HIDDEN_Y)
}

// After beating the rival, sets up the mareep sighting on the side
script ISLANDGAME_MINTY_MEADOWS_2_StartedQuest {
    setobjectxyperm(RIVAL_OW_ID, 35, 11)
    setobjectxyperm(OLD_MAN_OW_ID, 11, 6)
    setobjectxyperm(MAREEP_OW_ID, 32, 37)
    setobjectxyperm(MIGHTYENA_OW_ID, 32, 37)
}

// After sighting the mareep chase, sets up the final mareep encounter by the cave
script ISLANDGAME_MINTY_MEADOWS_2_SawMareepFirst {
    setobjectxyperm(RIVAL_OW_ID, 36, 26)
    setobjectxyperm(OLD_MAN_OW_ID, 11, 6)
    setobjectxyperm(MAREEP_OW_ID, 61, 12)
    setobjectxyperm(MIGHTYENA_OW_ID, 61, 15)
}

// After watching the pre-fight cutscene, wait for the player to beat the mightyena
script ISLANDGAME_MINTY_MEADOWS_2_SawMareepPreFight {
    setobjectxyperm(RIVAL_OW_ID, 61, 18)
    setobjectxyperm(OLD_MAN_OW_ID, 11, 6)
    setobjectxyperm(MAREEP_OW_ID, 61, 12)
    setobjectxyperm(MIGHTYENA_OW_ID, 61, 14)
}

// After the player beat the mightyena, remove all mareep-quest related stuff
script ISLANDGAME_MINTY_MEADOWS_2_DefeatedMightyena {
    setobjectxyperm(RIVAL_OW_ID, POS_HIDDEN_X, POS_HIDDEN_Y)
    setobjectxyperm(OLD_MAN_OW_ID, 11, 6)
    setobjectxyperm(MAREEP_OW_ID, POS_HIDDEN_X, POS_HIDDEN_Y)
    setobjectxyperm(MIGHTYENA_OW_ID, POS_HIDDEN_X, POS_HIDDEN_Y)
}

//RIVAL FIGHT
movement ISLANDGAME_MINTY_MEADOWS_2_RivalFight_Movement1 {
    walk_left * 4
}
movement ISLANDGAME_MINTY_MEADOWS_2_RivalFight_Movement2 {
    walk_left * 3
}
movement ISLANDGAME_MINTY_MEADOWS_2_RivalFight_Movement3 {
    walk_left * 2
}
movement ISLANDGAME_MINTY_MEADOWS_2_RivalFight_Movement4 {
    walk_left
}

movement ISLANDGAME_MINTY_MEADOWS_2_RivalFight_Movement6 {
    walk_right
}

script ISLANDGAME_MINTY_MEADOWS_2_RivalFight_Trigger1 {
    lock
    applymovement(RIVAL_OW_ID, ISLANDGAME_MINTY_MEADOWS_2_RivalFight_Movement1)
    waitmovement(RIVAL_OW_ID)
    goto(ISLANDGAME_MINTY_MEADOWS_2_RivalFight_Main)
}

script ISLANDGAME_MINTY_MEADOWS_2_RivalFight_Trigger2 {
    lock
    applymovement(RIVAL_OW_ID, ISLANDGAME_MINTY_MEADOWS_2_RivalFight_Movement2)
    waitmovement(RIVAL_OW_ID)
    goto(ISLANDGAME_MINTY_MEADOWS_2_RivalFight_Main)
}

script ISLANDGAME_MINTY_MEADOWS_2_RivalFight_Trigger3 {
    lock
    applymovement(RIVAL_OW_ID, ISLANDGAME_MINTY_MEADOWS_2_RivalFight_Movement3)
    waitmovement(RIVAL_OW_ID)
    goto(ISLANDGAME_MINTY_MEADOWS_2_RivalFight_Main)
}

script ISLANDGAME_MINTY_MEADOWS_2_RivalFight_Trigger4 {
    lock
    applymovement(RIVAL_OW_ID, ISLANDGAME_MINTY_MEADOWS_2_RivalFight_Movement4)
    waitmovement(RIVAL_OW_ID)
    goto(ISLANDGAME_MINTY_MEADOWS_2_RivalFight_Main)
}

script ISLANDGAME_MINTY_MEADOWS_2_RivalFight_Trigger5 {
    lock
    goto(ISLANDGAME_MINTY_MEADOWS_2_RivalFight_Main)
}

script ISLANDGAME_MINTY_MEADOWS_2_RivalFight_Trigger6 {
    lock
    applymovement(RIVAL_OW_ID, ISLANDGAME_MINTY_MEADOWS_2_RivalFight_Movement6)
    waitmovement(RIVAL_OW_ID)
    goto(ISLANDGAME_MINTY_MEADOWS_2_RivalFight_Main)
}

movement ISLANDGAME_MINTY_MEADOWS_2_RivalWalkDown {
    walk_down * 4
}

script ISLANDGAME_MINTY_MEADOWS_2_RivalFight_Main {
    applymovement(RIVAL_OW_ID, ISLANDGAME_MINTY_MEADOWS_2_RivalWalkDown)
    waitmovement(RIVAL_OW_ID)
    call(ISLANDGAME_MINTY_MEADOWS_2_RivalFight)
    release
}
script ISLANDGAME_MINTY_MEADOWS_2_RivalFight {
    msgbox(ISLANDGAME_MINTY_MEADOWS_2_IntroBattle_Text)
    trainerbattle_no_intro(TRAINER_MINTY_MEADOWS_RIVAL, ISLANDGAME_MINTY_MEADOWS_2_PostDefeated_Text)
    specialvar(VAR_RESULT, GetBattleOutcome)
    if (var(VAR_RESULT) != B_OUTCOME_WON) {
        return
    }
    msgbox(ISLANDGAME_MINTY_MEADOWS_2_PostDefeated_Text)
    // todo: old man walks over and starts quest, audrey runs off
    setvar(VAR_MINTY_MEADOWS_STATE, STATE_STARTED_QUEST)
    closemessage
    return
}

text ISLANDGAME_MINTY_MEADOWS_2_IntroBattle_Text {
    format("{COLOR DARK_GRAY}Rival battle intro")
}

text ISLANDGAME_MINTY_MEADOWS_2_PostDefeated_Text {
    format("{COLOR DARK_GRAY}post defeat rival")
}


//phase 1
const INNER_PATH_X = 32
const INNER_PATH_Y = 37

//phase 2
const CLEARING_M_X = 61
const CLEARING_M_Y = 15

const CLEARING_S_X = 61
const CLEARING_S_Y = 12

script ISLANDGAME_MINTY_MEADOWS_2_PrepareEncounter_Mightyena {
    addobject(MAREEP_OW_ID)
    addobject(MIGHTYENA_OW_ID)
    setobjectxy(MAREEP_OW_ID, CLEARING_S_X, CLEARING_S_Y)
    setobjectxyperm(MAREEP_OW_ID, CLEARING_S_X, CLEARING_S_Y)
    setobjectxy(MIGHTYENA_OW_ID, CLEARING_M_X, CLEARING_M_Y)
    setobjectxyperm(MIGHTYENA_OW_ID, CLEARING_M_X, CLEARING_M_Y)

    setobjectmovementtype(MAREEP_OW_ID, MOVEMENT_TYPE_FACE_DOWN)
    setobjectmovementtype(MIGHTYENA_OW_ID, MOVEMENT_TYPE_FACE_UP)
    return
}

script ISLANDGAME_MINTY_MEADOWS_2_SeeMareep_1 {
    lock
    setvar(VAR_MINTY_MEADOWS_STATE, 2)

    //spawn
    addobject(MAREEP_OW_ID)
    addobject(MIGHTYENA_OW_ID)
    setobjectxy(MAREEP_OW_ID, INNER_PATH_X, INNER_PATH_Y)
    setobjectxy(MIGHTYENA_OW_ID, INNER_PATH_X, INNER_PATH_Y)
    //spawn end
    //do movement
    applymovement(OBJ_EVENT_ID_PLAYER, Common_Movement_FaceDown)
    addobject(MAREEP_OW_ID)
    addobject(MIGHTYENA_OW_ID)
    applymovement(MAREEP_OW_ID, Phase1_MareepRun_1)
    waitmovement(MAREEP_OW_ID)
    playmoncry(SPECIES_MAREEP, CRY_MODE_ENCOUNTER)

    applymovement(MAREEP_OW_ID, Common_Movement_Delay48)
    waitmovement(MAREEP_OW_ID)

    playmoncry(SPECIES_MIGHTYENA, CRY_MODE_ENCOUNTER)
    applymovement(MAREEP_OW_ID, Phase1_MareepRun_2)
    waitmovement(MAREEP_OW_ID)
    
    applymovement(MAREEP_OW_ID, Phase1_MareepRun_3)
    applymovement(MIGHTYENA_OW_ID, Phase1_MightyenaChase)

    waitmovement(MIGHTYENA_OW_ID)
    waitmovement(MAREEP_OW_ID)
    call(ISLANDGAME_MINTY_MEADOWS_2_PrepareEncounter_Mightyena)
    release
}

script ISLANDGAME_MINTY_MEADOWS_2_SeeMareep_2 {
    lock
    setvar(VAR_MINTY_MEADOWS_STATE, 3)
    applymovement(MIGHTYENA_OW_ID, Phase2_MightyenaWalksForward)
    applymovement(MAREEP_OW_ID, Common_Movement_ExclamationMark)
    playmoncry(SPECIES_MIGHTYENA, CRY_MODE_ENCOUNTER)
    waitmoncry
    playmoncry(SPECIES_MAREEP, CRY_MODE_WEAK)
    waitmovement(MIGHTYENA_OW_ID)
    waitmoncry

    release
}

script ISLANDGAME_MINTY_MEADOWS_2_BattleMightyena {
    lock 
    faceplayer
    setwildbattle(SPECIES_SHADOW_MIGHTYENA, 25)
    playmoncry(SPECIES_MIGHTYENA, CRY_MODE_ENCOUNTER)
    waitmoncry
    setflag(FLAG_SYS_CTRL_OBJ_DELETE) 
    dowildbattle
    clearflag(FLAG_SYS_CTRL_OBJ_DELETE )
    specialvar(VAR_RESULT, GetBattleOutcome)
    switch (var(VAR_RESULT)) {
        case B_OUTCOME_CAUGHT:
        case B_OUTCOME_WON:
            setvar(VAR_MINTY_MEADOWS_STATE, 4)
            fadescreen(FADE_TO_BLACK)
            removeobject(MIGHTYENA_OW_ID) 
            fadescreen(FADE_FROM_BLACK)
            setobjectxyperm(MIGHTYENA_OW_ID, -3, 1) //shadow realmed
            msgbox(ConqueredMightyena_Text)
            waitmessage
        break
        case B_OUTCOME_RAN:
        case B_OUTCOME_PLAYER_TELEPORTED:
        break
    }
    release
}

//copypasted
script ISLANDGAME_MINTY_MEADOWS_2_TryRemoveMightyena {
	specialvar(VAR_RESULT, GetBattleOutcome)
	goto_if_ne(VAR_RESULT, B_OUTCOME_CAUGHT, Common_EventScript_NopReturn)
	removeobject(VAR_LAST_TALKED)
	return
}

script ISLANDGAME_MINTY_MEADOWS_2_Mareep {
    lock
    msgbox(MareepHelp_Text)
    release
}

text MareepHelp_Text {
    format("{COLOR BLUE}bro help me")
}

text ConqueredMightyena_Text {
    format("{COLOR DARK_GRAY} gg u won")
}

//movement spam
//phase 1
movement Phase1_MareepRun_1 {
    walk_up * 4
    step_end
}

movement Phase1_MareepRun_2 {
    face_down
    emote_exclamation_mark
    delay_16 * 1
    step_end
}

movement Phase1_MareepRun_3 {
    walk_fast_left * 13
    step_end
}

movement Phase1_MightyenaChase {
    walk_fast_up * 4
    walk_fast_left * 13
    step_end
}

//phase 2
movement Phase2_MightyenaWalksForward {
    walk_up
    step_end
}